<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Efrem Raimondo's Cookbook</title>
  <meta name="description" content="No‑nonsense recipes by Efrem Raimondo. Simple search, clean index, categories, single‑recipe view, and fast navigation." />
  <meta name="theme-color" content="#444444" />
  <meta name="color-scheme" content="light dark" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3E%F0%9F%8D%B4%3C/text%3E%3C/svg%3E" />
  <style>
    :root{
      --bg:#e9e9e9;
      --card:#ffffff;
      --ink:#222;
      --muted:#666;
      --brand:#ff13f0;
      --shadow:0 3px 6px rgba(0,0,0,.1);
      --shadow-lg:0 6px 16px rgba(0,0,0,.16);
      --radius:12px;
      --ok:#1a7f37;
      --bad:#c4302b;
    }
    @media (prefers-color-scheme: dark){
      :root{--bg:#141414;--card:#1e1e1e;--ink:#e9e9e9;--muted:#b7b7b7;--shadow:0 0 0 rgba(0,0,0,0);--shadow-lg:0 0 0 rgba(0,0,0,0)}
      header,footer{background:#1b1b1b}
      #search-bar,.pill,.btn{background:#1b1b1b;color:var(--ink);border-color:#333}
    }

    *{box-sizing:border-box}
    html:focus-within{scroll-behavior:smooth}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.6;margin:0;background:var(--bg);color:var(--ink)}
    header{background:#444;color:#fff;padding:28px 16px;text-align:center}
    header h1{margin:.2rem 0 0;font-size:clamp(1.4rem,2.5vw,1.9rem)}
    header p{margin:.3rem 0 0;color:#e8e8e8}

    .container{max-width:1100px;margin:0 auto;padding:20px}

    .skip{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}
    .skip:focus{position:static;width:auto;height:auto;margin:8px;display:inline-block;background:#fff;color:#000;padding:8px 12px;border-radius:10px}

    /* Tools row */
    .tools{display:grid;grid-template-columns:1fr;gap:12px;align-items:center}
    #search-wrap{display:flex;gap:12px;align-items:center}
    #search-bar{flex:1 1 360px;padding:12px 14px;border-radius:10px;border:1px solid #ccc;font-size:16px;outline:none}
    #search-bar:focus{border-color:#999;box-shadow:0 0 0 3px rgba(0,0,0,.06)}
    #count{color:var(--muted);font-size:.95rem}
    .single-bar{display:none;align-items:center;gap:10px;background:var(--card);border:1px solid #ddd;border-radius:10px;padding:8px 12px;box-shadow:var(--shadow)}
    .single-bar.show{display:flex}
    .btn{border:1px solid #ccc;border-radius:10px;padding:8px 12px;background:var(--card);cursor:pointer}
    .btn:hover{box-shadow:var(--shadow)}

    /* Category pills */
    .pill-group{display:flex;gap:8px;flex-wrap:wrap}
    .pill{padding:8px 12px;border-radius:999px;background:var(--card);border:1px solid #ccc;box-shadow:var(--shadow);cursor:pointer;font-size:.95rem}
    .pill[aria-pressed="true"]{background:var(--brand);color:#fff;border-color:transparent}
    .pill:focus{outline:3px solid rgba(255,19,240,.45);outline-offset:2px}

    /* Index grid */
    #recipe-index{display:grid;grid-template-columns:1fr;gap:14px;list-style:none;padding:0;margin:18px 0}
    @media (min-width: 700px){#recipe-index{grid-template-columns:1fr 1fr}}
    @media (min-width: 1000px){#recipe-index{grid-template-columns:1fr 1fr 1fr}}
    @media (min-width: 1400px){#recipe-index{grid-template-columns:1fr 1fr 1fr 1fr}}

    #recipe-index li{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px 16px;transition:transform .15s ease, box-shadow .15s ease}
    #recipe-index li:hover{transform:translateY(-2px);box-shadow:var(--shadow-lg)}
    #recipe-index a{display:block;text-decoration:none;color:inherit;font-weight:600}
    #recipe-index a:hover{color:var(--brand);text-decoration:underline}

    .recipe{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin:18px 0}
    .recipe h3{margin-top:0}
    .recipe .meta{color:var(--muted);font-size:.9rem;margin-top:-6px}
    .recipe mark{padding:0 .15em;border-radius:4px}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin:.5rem 0}

    /* Legacy cover (kept for compatibility) */
    .cover{width:100%;aspect-ratio:16/9;border-radius:var(--radius);overflow:hidden;background:#f3f3f3;margin:.75rem 0;box-shadow:var(--shadow)}
    .cover img{width:100%;height:100%;object-fit:cover;display:block}

    /* NEW: responsive recipe view grid + sticky aside image */
    .recipe-grid{display:grid;gap:20px}
    @media (min-width:768px){.recipe-grid{grid-template-columns:1fr 360px;align-items:start}}
    .sticky{position:sticky;top:24px}
    .thumb{width:100%;aspect-ratio:1/1;overflow:hidden;border-radius:var(--radius);border:1px solid #ddd;background:#f3f3f3}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}

    footer{text-align:center;padding:18px;background:#444;color:#fff;margin-top:32px}

    a:focus,button:focus,input:focus{outline:3px solid rgba(255,19,240,.45);outline-offset:2px}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    /* Print */
    @media print{
      header, .tools, #index{display:none}
      body{background:#fff;color:#000}
      .recipe{box-shadow:none;border:0;margin:0;padding:0 0 16px 0;page-break-inside:avoid}
      .cover{margin:0 0 8px 0;box-shadow:none}
    }

    /* Simple modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:grid;place-items:center;padding:16px;z-index:1000}
    .modal-card{background:var(--card);color:var(--ink);border-radius:var(--radius);box-shadow:var(--shadow-lg);padding:16px;max-width:720px;width:100%}
    .modal-card label{display:block;margin:.6rem 0}
    .modal-card input,.modal-card textarea{width:100%;padding:10px;border:1px solid #ccc;border-radius:10px;background:var(--card);color:var(--ink)}
    .modal-card textarea{font-family:inherit}
  </style>
</head>
<body>
  <a href="#main" class="skip">Skip to content</a>
  <header role="banner">
    <h1>Efrem Raimondo's Cookbook</h1>
    <p>No‑nonsense instructions to save your cooking (and your sanity).</p>
  </header>

  <main id="main" class="container">
    <div class="tools" role="search">
      <div id="search-wrap">
        <label for="search-bar" class="sr-only">Search recipes</label>
        <input id="search-bar" type="search" placeholder="Search recipes, ingredients… (press / to focus)" autocomplete="off" aria-describedby="count help" />
        <div id="count" aria-live="polite"></div>
      </div>
      <p id="help" class="sr-only">Use Left/Right to switch category, Enter to open a recipe, Esc to exit single view.</p>
      <nav aria-label="Categories" class="pill-group" id="categories"></nav>
      <div id="test-output" aria-live="polite"></div>
      <button id="add-recipe" class="btn" type="button" hidden aria-label="Add recipe (private)" title="Add a new recipe">＋</button>
      <div id="single-bar" class="single-bar" aria-live="polite">
        <span id="single-label"></span>
        <button id="show-all" class="btn" type="button">Show all</button>
      </div>
    </div>

    <section id="index" aria-labelledby="index-title">
      <h2 id="index-title">Index</h2>
      <ul id="recipe-index" role="list"></ul>
    </section>

    <section id="recipes" aria-labelledby="recipes-title">
      <h2 id="recipes-title">Recipes</h2>
      <div id="recipe-list"></div>
    </section>

    <!-- Add-recipe modal (private) -->
    <div id="add-modal" class="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="add-title" style="display:none">
      <div class="modal-card" role="document">
        <h3 id="add-title">Add a new recipe</h3>
        <form id="add-form">
          <label>Title<br><input id="add-title-input" type="text" required placeholder="e.g., Carbonara" /></label>
          <label>Categories (comma separated)<br><input id="add-cats" type="text" placeholder="Pasta, Sauce" /></label>
          <label>Ingredients (one per line)<br><textarea id="add-ings" rows="6" placeholder="200 g spaghetti&#10;2 eggs&#10;..." required></textarea></label>
          <label>Instructions<br><textarea id="add-steps" rows="8" placeholder="Write steps..." required></textarea></label>
          <!-- NEW: image url field -->
          <label>Image URL (optional)<br><input id="add-image" type="url" placeholder="https://.../your-photo.jpg" /></label>
          <div class="actions">
            <button type="submit" class="btn">Save</button>
            <button type="button" class="btn" id="add-cancel">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <footer role="contentinfo">
    <p>&copy; <span id="year"></span> Efrem Raimondo's Cookbook</p>
  </footer>

  <script>
    // --- Data (your original content + categories) ---
    const baseRecipes = [
      { title: "Beurre Café de Paris", categories: ["Sauce"],
        image: "https://joyfoodsunshine.com/wp-content/uploads/2018/09/easy-homemade-pizza-dough-recipe-2-1.jpg", // optional per‑recipe image
        ingredients: [
          "3 scallions, thinly sliced","1 clove of garlic","2 teaspoons of mustard","2 anchovies","6 teaspoons of Worcestershire sauce","Parsley, chopped","Zest of 1 lemon","5 teaspoons of lemon juice","1/2 stick of butter"],
        instructions: `
          Thinly slice the 3 scallions. Melt part of the butter in a skillet and sauté the scallions until soft and lightly golden. Remove from heat and allow to cool.
          In a blender, combine the garlic clove, anchovies, parsley, mustard, Worcestershire sauce, lemon zest, lemon juice, and the remaining fresh butter. Add the sautéed scallions and blend everything together until smooth.
          Blend until the mixture reaches a creamy, homogenous consistency. Add a pinch of salt to taste. Refrigerate before serving.
        `},
      { title: "Filetto al Pepe Verde", categories: ["Meat","Beef"],
        image: "",
        ingredients: [
          "800 g whole beef tenderloin","30 g green peppercorns in brine","100 g fresh liquid cream","50 g Dijon mustard","120 g hot beef broth","30 g brandy","40 g clarified butter","Salt, to taste","All-purpose flour, as needed"],
        instructions: `
          Clean the tenderloin and cut it into 4 medallions of 200 g each. Tie each medallion with kitchen twine to maintain their shape. Lightly flour both sides of each medallion.
          Heat the clarified butter in a skillet over medium-high heat and sear the medallions for 2 minutes on each side. Deglaze the pan with brandy and flambé, or allow the alcohol to evaporate.
          Lower the heat and add the drained green peppercorns, Dijon mustard, 50 g of cream, and 50 g of beef broth. Cook for another 2 minutes on each side, basting the meat with the sauce.
          Remove the medallions and let them rest. In the same skillet, add the remaining cream and broth, and reduce the sauce until thickened.
          Return the medallions to the skillet for a few seconds, coat them with the sauce, and serve immediately.
        `},
    ];

    // Merge-in user recipes saved locally (private additions)
    let recipes = [];
    function loadUserRecipes(){
      try{ const raw = localStorage.getItem('userRecipes'); return raw ? JSON.parse(raw) : []; }catch(_){ return []; }
    }
    function saveUserRecipes(arr){ try{ localStorage.setItem('userRecipes', JSON.stringify(arr)); }catch(_){} }
    function recomputeRecipes(){ recipes = [...baseRecipes, ...loadUserRecipes()]; }

    // --- State & helpers ---
    let selectedCategory = localStorage.getItem('cat') || 'All';
    let selectedRecipeId = null; // when set, show only that recipe

    const slug = s => s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
    const escapeHtml = s => s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));

    function highlight(text, term){
      if(!term) return escapeHtml(text);
      const safe = term.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
      return escapeHtml(text).replace(new RegExp(`(${safe})`,`ig`), '<mark>$1</mark>');
    }

    function debounced(fn, wait=120){
      let t;return (...args)=>{clearTimeout(t);t=setTimeout(()=>fn(...args),wait)}
    }

    function collectCategories(list){
      const set = new Set(['All']);
      list.forEach(r=>{ (r.categories||['Uncategorized']).forEach(c=> set.add(c)); });
      return Array.from(set);
    }

    function renderCategories(list){
      const nav = document.getElementById('categories');
      nav.innerHTML = '';
      const cats = collectCategories(list);
      cats.forEach((c,idx)=>{
        const b = document.createElement('button');
        b.className = 'pill';
        b.type = 'button';
        b.textContent = c;
        b.setAttribute('aria-pressed', String(c===selectedCategory));
        b.setAttribute('data-index', idx);
        b.addEventListener('click', ()=>{ selectedCategory = c; localStorage.setItem('cat', c); selectedRecipeId=null; update(); });
        nav.appendChild(b);
      });
    }

    function renderIndex(list){
      const ul = document.getElementById('recipe-index');
      ul.innerHTML = '';
      list.forEach(r=>{
        const id = slug(r.title);
        const li = document.createElement('li');
        li.innerHTML = `<a href="#${id}" data-id="${id}">${escapeHtml(r.title)}</a>`;
        ul.appendChild(li);
      });
      document.getElementById('count').textContent = `${list.length} recipe${list.length===1?'':'s'}`;
      ul.querySelectorAll('a').forEach(a=>{
        a.addEventListener('click', ()=>{
          selectedRecipeId = a.getAttribute('data-id');
          update();
        });
      });
    }

    function renderRecipes(list, term=''){
      const wrap = document.getElementById('recipe-list');
      wrap.innerHTML = '';
      let items = list;
      if(selectedRecipeId){ items = list.filter(r=> slug(r.title)===selectedRecipeId); }
      items.forEach(r=>{
        const id = slug(r.title);
        const art = document.createElement('article');
        art.className = 'recipe';
        art.id = id;
        art.tabIndex = -1;
        const ing = r.ingredients.map(i=>`<li>${highlight(i, term)}</li>`).join('');
        const cats = (r.categories||['Uncategorized']).join(', ');

        const imgSrc = (r.image && r.image.trim()) ? escapeHtml(r.image.trim()) : '/images/placeholder.png';
        const imgAlt = escapeHtml(r.imageAlt || r.title);

        art.innerHTML = `
          <div class="recipe-grid">
            <section>
              <h3><button class="btn" data-open="${id}" style="border:none;background:transparent;padding:0;font:inherit;color:inherit;text-align:left">${highlight(r.title, term)}</button></h3>
              <div class="meta">${r.ingredients.length} ingredients • ${cats}</div>
              <div class="actions">
                <button class="btn" data-copy="${id}-ingredients" aria-label="Copy ingredients for ${escapeHtml(r.title)}">Copy ingredients</button>
                <button class="btn" data-copy="${id}-instructions" aria-label="Copy instructions for ${escapeHtml(r.title)}">Copy steps</button>
              </div>
              <h4>Ingredients</h4>
              <ul id="${id}-ingredients">${ing}</ul>
              <h4>Instructions</h4>
              <div id="${id}-instructions"><p>${highlight(r.instructions.trim(), term).replace(/\n\n/g,'</p><p>')}</p></div>
            </section>
            <aside class="sticky">
              <figure class="thumb">
                <img src="${imgSrc}" alt="${imgAlt}" loading="lazy" decoding="async" />
              </figure>
            </aside>
          </div>
        `;
        wrap.appendChild(art);
      });
      // Title click also enables single view
      wrap.querySelectorAll('[data-open]').forEach(b=>{
        b.addEventListener('click', ()=>{
          selectedRecipeId = b.getAttribute('data-open');
          update();
          const target = document.getElementById(selectedRecipeId);
          if(target) target.focus({preventScroll:true});
        });
      });
      // Copy buttons
      wrap.querySelectorAll('[data-copy]').forEach(b=>{
        b.addEventListener('click', async ()=>{
          const sel = document.getElementById(b.getAttribute('data-copy'));
          const txt = sel ? sel.innerText.replace(/\n+/g,'\n').trim() : '';
          try{ await navigator.clipboard.writeText(txt); b.textContent = 'Copied!'; setTimeout(()=>{ const isIng = b.getAttribute('data-copy').includes('ingredients'); b.textContent = 'Copy ' + (isIng?'ingredients':'steps'); },1200);}catch(e){ alert('Could not copy.'); }
        });
      });

      // Single bar state
      const bar = document.getElementById('single-bar');
      const label = document.getElementById('single-label');
      if(selectedRecipeId){
        const r = list.find(x=> slug(x.title)===selectedRecipeId) || {title:selectedRecipeId};
        bar.classList.add('show');
        label.textContent = `Viewing: ${r.title}`;
      } else {
        bar.classList.remove('show');
        label.textContent = '';
      }
    }

    function filter(list, q){
      const matchSearch = (r)=>{
        if(!q) return true;
        const t = q.toLowerCase();
        return r.title.toLowerCase().includes(t) ||
          (r.categories||[]).some(cat=>cat.toLowerCase().includes(t)) ||
          r.ingredients.some(i=>i.toLowerCase().includes(t)) ||
          r.instructions.toLowerCase().includes(t);
      };
      const matchCat = (r)=> selectedCategory==='All' ? true : (r.categories||['Uncategorized']).includes(selectedCategory);
      return list.filter(r=> matchSearch(r) && matchCat(r));
    }

    const onSearch = debounced(()=>{ selectedRecipeId=null; localStorage.setItem('q', document.getElementById('search-bar').value.trim()); update(); }, 150);

    function handleHash(){
      const id = location.hash.replace('#','');
      selectedRecipeId = id || null;
      update(true); // keep current hash
      if(id){
        const target = document.getElementById(id);
        if(target){ target.scrollIntoView({behavior:'smooth', block:'start'}); target.focus({preventScroll:true}); }
      }
    }

    function update(keepHash){
      const q = document.getElementById('search-bar').value.trim();
      const filtered = filter(recipes, q);
      renderCategories(recipes);
      [...document.querySelectorAll('#categories .pill')].forEach(b=> b.setAttribute('aria-pressed', String(b.textContent===selectedCategory)));
      renderIndex(filtered);
      renderRecipes(filtered, q);
      if(!keepHash){
        if(selectedRecipeId) location.hash = '#' + selectedRecipeId; else history.replaceState(null,'', location.pathname + location.search);
      }
    }

    // --- Tests ---
    function runTests(){
      const out = [];
      const ok = (cond, name)=>{ out.push({name, cond}); };
      try{
        const target = 'a+b (c)? [x] \\ ^ $';
        const term = 'a+b (c)? [x] \\ ^ $';
        const res = highlight(target, term);
        ok(res.includes('<mark>'), 'highlight() marks a term with regex specials');
      }catch(e){ ok(false, 'highlight() throws with regex specials'); }

      // Category-only filter (use existing data)
      const prev = selectedCategory; selectedCategory = 'Meat';
      ok(filter(recipes, '').length >= 1, 'filter() by category only (Meat) finds at least one');
      selectedCategory = prev;

      // Category + search combined
      const prev2 = selectedCategory; selectedCategory = 'Meat';
      ok(filter(recipes, 'Dijon').map(r=>r.title).includes('Filetto al Pepe Verde'), 'filter() combines category AND search');
      selectedCategory = prev2;

      // Single view shows only one article
      const before = document.getElementById('recipe-list').children.length;
      const firstId = slug(recipes[0].title); selectedRecipeId = firstId; update();
      const after = document.getElementById('recipe-list').children.length;
      ok(before === 0 || after === 1, 'single-view shows only one article');
      selectedRecipeId = null; update();

      ok(typeof navigator.clipboard !== 'undefined', 'Clipboard API exists (may fail in some contexts)');

      // HTML escaping
      ok(escapeHtml('<>&"\'').includes('&lt;') && escapeHtml('<>&"\'').includes('&quot;'), 'escapeHtml() escapes HTML chars');

      // Instruction paragraph split
      const phtml = highlight('a\n\nb', '').replace(/\n\n/g,'</p><p>');
      ok(phtml.includes('</p><p>'), 'instructions paragraph split works');

      // Image fallback: render a temp recipe with no image
      const snapshot = document.getElementById('recipe-list').innerHTML;
      const tmp = [{title:'Tmp Recipe', categories:['Test'], ingredients:['x'], instructions:'step'}];
      renderRecipes(tmp, '');
      const img = document.querySelector('#recipe-list img');
      ok(img && img.getAttribute('src') && img.getAttribute('src').includes('placeholder.png'), 'image fallback uses placeholder');
      // Image provided: should use custom url
      const tmp2 = [{title:'Tmp Recipe 2', image:'https://example.com/pic.jpg', categories:['Test'], ingredients:['y'], instructions:'step'}];
      renderRecipes(tmp2, '');
      const img2 = document.querySelector('#recipe-list img');
      ok(img2 && img2.getAttribute('src') && img2.getAttribute('src').includes('example.com/pic.jpg'), 'image src uses provided URL');
      // Restore
      document.getElementById('recipe-list').innerHTML = snapshot;
      update();

      const passed = out.filter(t=>t.cond).length;
      const failed = out.length - passed;
      const el = document.getElementById('test-output');
      el.innerHTML = failed>0
        ? `<span class="fail">✗ ${failed} tests failed (${passed} passed)</span>`
        : '';
      try{ console.table(out.map(t=>({test:t.name, result:t.cond?'PASS':'FAIL'}))); }catch(_){}}

    (function init(){
      document.getElementById('year').textContent = new Date().getFullYear();

      // Private mode detection: localhost/.local OR ?admin OR stored flag
      const url = new URL(location.href);
      if(url.searchParams.has('admin')){ localStorage.setItem('cookbook_admin','1'); url.searchParams.delete('admin'); history.replaceState(null,'', url.pathname + (url.searchParams.toString()?('?'+url.searchParams.toString()):'')); }
      const isPrivate = ['localhost','127.0.0.1','::1',''].includes(location.hostname) || location.hostname.endsWith('.local') || localStorage.getItem('cookbook_admin')==='1';

      // Build recipes with user additions
      recomputeRecipes();

      renderCategories(recipes);
      renderIndex(recipes);
      renderRecipes(recipes);

      const search = document.getElementById('search-bar');
      const savedQ = localStorage.getItem('q');
      if(savedQ){ search.value = savedQ; }
      search.addEventListener('input', onSearch);

      document.getElementById('show-all').addEventListener('click', ()=>{ selectedRecipeId=null; update(); });
      window.addEventListener('hashchange', handleHash);

      // Shortcuts
      window.addEventListener('keydown', (e)=>{
        if(e.key === '/' && document.activeElement !== search){ e.preventDefault(); search.focus(); return; }
        if(e.key === 'Escape' && selectedRecipeId){ selectedRecipeId = null; update(); }
        if(['ArrowLeft','ArrowRight'].includes(e.key)){
          const pills = [...document.querySelectorAll('#categories .pill')];
          const idx = pills.findIndex(p=>p.textContent===selectedCategory);
          if(idx !== -1){
            const next = e.key==='ArrowRight' ? Math.min(idx+1, pills.length-1) : Math.max(idx-1, 0);
            pills[next].click();
          }
        }
        if(e.key === 'Enter' && !selectedRecipeId){
          const first = document.querySelector('#recipe-index a');
          if(first){ first.click(); }
        }
      });

      // Private add button wiring
      const addBtn = document.getElementById('add-recipe');
      const modal = document.getElementById('add-modal');
      const form = document.getElementById('add-form');
      const cancel = document.getElementById('add-cancel');
      if(isPrivate){ addBtn.hidden = false; }

      function openModal(){ modal.style.display = 'grid'; modal.setAttribute('aria-hidden','false'); document.getElementById('add-title-input').focus(); }
      function closeModal(){ modal.style.display = 'none'; modal.setAttribute('aria-hidden','true'); form.reset(); }
      addBtn.addEventListener('click', openModal);
      cancel.addEventListener('click', closeModal);
      modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });

      form.addEventListener('submit', (e)=>{
        e.preventDefault();
        const title = (document.getElementById('add-title-input').value||'').trim();
        const cats = (document.getElementById('add-cats').value||'').split(',').map(s=>s.trim()).filter(Boolean);
        const ings = (document.getElementById('add-ings').value||'').split('\n').map(s=>s.trim()).filter(Boolean);
        const steps = (document.getElementById('add-steps').value||'').trim();
        const image = (document.getElementById('add-image').value||'').trim();
        if(!title || !steps || ings.length===0){ alert('Please fill title, at least one ingredient, and instructions.'); return; }
        const rec = { title, categories: (cats.length?cats:['Uncategorized']), ingredients: ings, instructions: steps };
        if(image) rec.image = image;
        // Save to local storage list
        const current = loadUserRecipes();
        current.push(rec); saveUserRecipes(current);
        recomputeRecipes();
        selectedRecipeId = slug(title);
        update();
        closeModal();
      });

      handleHash();
      runTests();
    })();
  </script>
</body>
</html>
