<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Efrem Raimondo's Cookbook</title>
  <meta name="description" content="No‑nonsense recipes by Efrem Raimondo. Simple search, clean index, categories, single‑recipe view, and fast navigation." />
  <meta name="theme-color" content="#444444" />
  <meta name="color-scheme" content="light dark" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3E%F0%9F%8D%B4%3C/text%3E%3C/svg%3E" />
  <style>
    :root{
      --bg:#e9e9e9;
      --card:#ffffff;
      --ink:#222;
      --muted:#666;
      --brand:#ff13f0;
      --shadow:0 3px 6px rgba(0,0,0,.1);
      --shadow-lg:0 6px 16px rgba(0,0,0,.16);
      --radius:12px;
      --ok:#1a7f37;
      --bad:#c4302b;
    }
    @media (prefers-color-scheme: dark){
      :root{--bg:#141414;--card:#1e1e1e;--ink:#e9e9e9;--muted:#b7b7b7;--shadow:0 0 0 rgba(0,0,0,0);--shadow-lg:0 0 0 rgba(0,0,0,0)}
      header,footer{background:#1b1b1b}
      #search-bar,.pill,.btn{background:#1b1b1b;color:var(--ink);border-color:#333}
    }

    *{box-sizing:border-box}
    html:focus-within{scroll-behavior:smooth}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.6;margin:0;background:var(--bg);color:var(--ink)}
    header{background:#444;color:#fff;padding:28px 16px;text-align:center}
    header h1{margin:.2rem 0 0;font-size:clamp(1.4rem,2.5vw,1.9rem)}
    header p{margin:.3rem 0 0;color:#e8e8e8}

    .container{max-width:1100px;margin:0 auto;padding:20px}

    .skip{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}
    .skip:focus{position:static;width:auto;height:auto;margin:8px;display:inline-block;background:#fff;color:#000;padding:8px 12px;border-radius:10px}

    /* Tools row */
    .tools{display:grid;grid-template-columns:1fr;gap:12px;align-items:center}
    #search-wrap{display:flex;gap:12px;align-items:center}
    #search-bar{flex:1 1 360px;padding:12px 14px;border-radius:10px;border:1px solid #ccc;font-size:16px;outline:none}
    #search-bar:focus{border-color:#999;box-shadow:0 0 0 3px rgba(0,0,0,.06)}
    #count{color:var(--muted);font-size:.95rem}
    .single-bar{display:none;align-items:center;gap:10px;background:var(--card);border:1px solid #ddd;border-radius:10px;padding:8px 12px;box-shadow:var(--shadow)}
    .single-bar.show{display:flex}
    .btn{border:1px solid #ccc;border-radius:10px;padding:8px 12px;background:var(--card);cursor:pointer}
    .btn:hover{box-shadow:var(--shadow)}

    /* Category pills */
    .pill-group{display:flex;gap:8px;flex-wrap:wrap}
    .pill{padding:8px 12px;border-radius:999px;background:var(--card);border:1px solid #ccc;box-shadow:var(--shadow);cursor:pointer;font-size:.95rem}
    .pill[aria-pressed="true"]{background:var(--brand);color:#fff;border-color:transparent}
    .pill:focus{outline:3px solid rgba(255,19,240,.45);outline-offset:2px}

    /* Index grid */
    #recipe-index{display:grid;grid-template-columns:1fr;gap:14px;list-style:none;padding:0;margin:18px 0}
    @media (min-width: 700px){#recipe-index{grid-template-columns:1fr 1fr}}
    @media (min-width: 1000px){#recipe-index{grid-template-columns:1fr 1fr 1fr}}
    @media (min-width: 1400px){#recipe-index{grid-template-columns:1fr 1fr 1fr 1fr}}

    #recipe-index li{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px 16px;transition:transform .15s ease, box-shadow .15s ease}
    #recipe-index li:hover{transform:translateY(-2px);box-shadow:var(--shadow-lg)}
    #recipe-index a{display:block;text-decoration:none;color:inherit;font-weight:600}
    #recipe-index a:hover{color:var(--brand);text-decoration:underline}

    .recipe{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin:18px 0}
    .recipe h3{margin-top:0}
    .recipe .meta{color:var(--muted);font-size:.9rem;margin-top:-6px}
    .recipe mark{padding:0 .15em;border-radius:4px}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin:.5rem 0}

    footer{text-align:center;padding:18px;background:#444;color:#fff;margin-top:32px}

    a:focus,button:focus,input:focus{outline:3px solid rgba(255,19,240,.45);outline-offset:2px}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    /* Print */
    @media print{
      header, .tools, #index{display:none}
      body{background:#fff;color:#000}
      .recipe{box-shadow:none;border:0;margin:0;padding:0 0 16px 0;page-break-inside:avoid}
    }

    /* Simple modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:grid;place-items:center;padding:16px;z-index:1000}
    .modal-card{background:var(--card);color:var(--ink);border-radius:var(--radius);box-shadow:var(--shadow-lg);padding:16px;max-width:720px;width:100%}
    .modal-card label{display:block;margin:.6rem 0}
    .modal-card input,.modal-card textarea{width:100%;padding:10px;border:1px solid #ccc;border-radius:10px;background:var(--card);color:var(--ink)}
    .modal-card textarea{font-family:inherit}
  </style>
</head>
<body>
  <a href="#main" class="skip">Skip to content</a>
  <header role="banner">
    <h1>Efrem Raimondo's Cookbook</h1>
    <p>No‑nonsense instructions to save your cooking (and your sanity).</p>
  </header>

  <main id="main" class="container">
    <div class="tools" role="search">
      <div id="search-wrap">
        <label for="search-bar" class="sr-only">Search recipes</label>
        <input id="search-bar" type="search" placeholder="Search recipes, ingredients… (press / to focus)" autocomplete="off" aria-describedby="count help" />
        <div id="count" aria-live="polite"></div>
      </div>
      <p id="help" class="sr-only">Use Left/Right to switch category, Enter to open a recipe, Esc to exit single view.</p>
      <nav aria-label="Categories" class="pill-group" id="categories"></nav>
      <div id="test-output" aria-live="polite"></div>
      <button id="add-recipe" class="btn" type="button" hidden aria-label="Add recipe (private)" title="Add a new recipe">＋</button>
      <div id="single-bar" class="single-bar" aria-live="polite">
        <span id="single-label"></span>
        <button id="show-all" class="btn" type="button">Show all</button>
      </div>
    </div>

    <section id="index" aria-labelledby="index-title">
      <h2 id="index-title">Index</h2>
      <ul id="recipe-index" role="list"></ul>
    </section>

    <section id="recipes" aria-labelledby="recipes-title">
      <h2 id="recipes-title">Recipes</h2>
      <div id="recipe-list"></div>
    </section>

    <!-- Add-recipe modal (private) -->
    <div id="add-modal" class="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="add-title" style="display:none">
      <div class="modal-card" role="document">
        <h3 id="add-title">Add a new recipe</h3>
        <form id="add-form">
          <label>Title<br><input id="add-title-input" type="text" required placeholder="e.g., Carbonara" /></label>
          <label>Categories (comma separated)<br><input id="add-cats" type="text" placeholder="Pasta, Sauce" /></label>
          <label>Ingredients (one per line)<br><textarea id="add-ings" rows="6" placeholder="200 g spaghetti&#10;2 eggs&#10;..." required></textarea></label>
          <label>Instructions<br><textarea id="add-steps" rows="8" placeholder="Write steps..." required></textarea></label>
          <div class="actions">
            <button type="submit" class="btn">Save</button>
            <button type="button" class="btn" id="add-cancel">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <footer role="contentinfo">
    <p>&copy; <span id="year"></span> Efrem Raimondo's Cookbook</p>
  </footer>

  <script>
    // --- Data (your original content + categories) ---
    const baseRecipes = [
      { title: "Beurre Café de Paris", categories: ["Sauce"], ingredients: [
          "3 scallions, thinly sliced","1 clove of garlic","2 teaspoons of mustard","2 anchovies","6 teaspoons of Worcestershire sauce","Parsley, chopped","Zest of 1 lemon","5 teaspoons of lemon juice","1/2 stick of butter"],
        instructions: `
          Thinly slice the 3 scallions. Melt part of the butter in a skillet and sauté the scallions until soft and lightly golden. Remove from heat and allow to cool.
          In a blender, combine the garlic clove, anchovies, parsley, mustard, Worcestershire sauce, lemon zest, lemon juice, and the remaining fresh butter. Add the sautéed scallions and blend everything together until smooth.
          Blend until the mixture reaches a creamy, homogenous consistency. Add a pinch of salt to taste. Refrigerate before serving.
        `},
      { title: "Filetto al Pepe Verde", categories: ["Meat","Beef"], ingredients: [
          "800 g whole beef tenderloin","30 g green peppercorns in brine","100 g fresh liquid cream","50 g Dijon mustard","120 g hot beef broth","30 g brandy","40 g clarified butter","Salt, to taste","All-purpose flour, as needed"],
        instructions: `
          Clean the tenderloin and cut it into 4 medallions of 200 g each. Tie each medallion with kitchen twine to maintain their shape. Lightly flour both sides of each medallion.
          Heat the clarified butter in a skillet over medium-high heat and sear the medallions for 2 minutes on each side. Deglaze the pan with brandy and flambé, or allow the alcohol to evaporate.
          Lower the heat and add the drained green peppercorns, Dijon mustard, 50 g of cream, and 50 g of beef broth. Cook for another 2 minutes on each side, basting the meat with the sauce.
          Remove the medallions and let them rest. In the same skillet, add the remaining cream and broth, and reduce the sauce until thickened.
          Return the medallions to the skillet for a few seconds, coat them with the sauce, and serve immediately.
        `},
      { title: "Poulet Crémeux à la Dijon", categories: ["Meat","Chicken"], ingredients: [
          "150 g roasted potatoes (oven or air fryer)","175 g chicken breast or thigh, raw","1/2 onion, chopped","2 garlic cloves, minced","2 shallots (optional)","1 teaspoon olive oil","Bay leaf, to taste","2 teaspoons onion powder","2 teaspoons paprika","2 teaspoons Italian seasoning","2 teaspoons salt and black pepper (adjust to taste)","2 teaspoons Dijon mustard","1 cup vegetable or chicken broth","1/2 cup light cream","1/2 cup milk of choice","Fresh parsley for garnish"],
        instructions: `
          Roast the potatoes in the oven or air fryer at 200°C (390°F) for 20 minutes.
          In a skillet or pot over high heat, add olive oil, chicken, and halved shallots (if using). Season with salt, black pepper, paprika, onion powder, Italian seasoning, and a bay leaf. Grill the chicken until fully cooked, approximately 10-12 minutes. Remove and set aside.
          Lower the heat to medium, and in the same skillet, add minced garlic, chopped onion, paprika, Italian seasoning, and Dijon mustard. Sauté until the onion becomes translucent and fragrant, about 2-3 minutes.
          Pour in the vegetable or chicken broth, light cream, and milk. Mix well to combine all the ingredients. Let the sauce simmer for 5 minutes, allowing the flavors to blend and the sauce to thicken slightly.
          Remove the skillet from the heat and return the chicken and shallots to the sauce. Garnish with fresh parsley leaves.
          Serve the creamy Dijon chicken with the roasted potatoes. Enjoy your meal!
        `},
      { title: "Pasta", categories: ["Pasta"], ingredients: [
          "300 g of flour","100 g of water + 1 egg (or 150 g of water if not using an egg)","A pinch of salt"],
        instructions: `
          In a large bowl, combine the flour and a pinch of salt.
          If using an egg, lightly beat it and mix it with 100 g of water. If you prefer egg-free pasta, use an additional 50 g of water.
          Create a well in the center of the flour and pour in the water (and the egg, if used). Start incorporating the flour into the liquids, mixing until a dough forms.
          Transfer the dough onto a lightly floured surface and knead for about 10 minutes until it becomes smooth and elastic. If the dough is too sticky, add a little more flour; if it’s too dry, add a small amount of water.
          Wrap the dough in plastic wrap (cling film) and let it rest in the refrigerator for 20 minutes. This resting time allows the gluten to relax, making the dough easier to roll out.
          After resting, divide the dough into smaller portions. Using a pasta machine, begin rolling out the dough at the widest setting, gradually decreasing the thickness until you reach setting number 4.
          Your pasta is now ready to be used in your favorite recipe. Cut it into your desired shape or use it as sheets for lasagna.
        `},
      { title: "Gnocchi", categories: ["Pasta"], ingredients: [
          "4 large potatoes (about 800 g)","All-purpose flour (as needed, about 200–300 g)","Salt, to taste"],
        instructions: `
          Place the potatoes in a large pot of salted water. Bring to a boil and cook until tender, about 20–25 minutes. A fork should easily pierce through them.
          Once cooked, drain the potatoes and let them cool slightly. Peel the potatoes and mash them thoroughly until you achieve a smooth consistency.
          Gradually add the flour to the mashed potatoes along with a pinch of salt. Mix until the dough is no longer sticky but still soft and workable. Avoid overworking the dough.
          Divide the dough into smaller portions. Roll each portion into a long, thin rope about 2 centimeters in diameter. Cut each rope into small pieces, about 2 centimeters long.
          Gently press each piece onto the tines of a fork, rolling it slightly to create ridges. This texture helps the sauce adhere better to the gnocchi.
          Bring a large pot of salted water to a boil. Cook the gnocchi in small batches until they float to the surface, about 2–3 minutes.
          Remove the gnocchi with a slotted spoon and serve immediately with your preferred sauce.
        `},
      { title: "Pizza", categories: ["Bread","Main"], ingredients: [
          "250 ml lukewarm water","400 g all-purpose flour","2 tablespoons olive oil","3 teaspoons salt","1 teaspoon granulated sugar","1 tablespoon dry yeast or 1/4 block of fresh yeast"],
        instructions: `
          In a bowl, dissolve the yeast (dry or fresh) in the lukewarm water with the sugar. Let it rest for a few minutes until the yeast begins to foam.
          Gradually add the flour to the bowl, mixing by hand as you go. Continue adding and mixing until a dough forms.
          Add the salt and olive oil to the dough and continue mixing by hand until all ingredients are fully incorporated.
          Transfer the dough to a lightly floured surface and knead by hand for about 10 minutes, using the palms of your hands to push the dough forward, then folding it back and turning slightly each time, until it becomes smooth and elastic.
          Place the dough in a bowl lightly greased with olive oil, cover it with plastic wrap, and let it rise in a warm place for about 1–2 hours, or until it doubles in size.
          Once the dough has risen, gently deflate it with your hands and transfer it to a lightly floured surface.
          Roll out the dough with your hands to achieve the desired shape and thickness.
          Add your preferred toppings to the surface of the dough.
          Bake in a preheated oven at 170°C (340°F) for 20–25 minutes, or until the pizza is golden and crispy.
        `}
      { 
  title: "Focaccia", 
  categories: ["Bread"], 
  ingredients: [
    "500 g type 0 flour",
    "340 g water (room temperature)",
    "7 g fresh brewer’s yeast",
    "25 g extra virgin olive oil",
    "10 g fine salt",
    "60 g extra virgin olive oil (for topping)",
    "Maldon salt (q.b.)"
  ],
  instructions: `
    In a bowl, mix flour with crumbled yeast. Add water gradually, stirring until absorbed. When dough starts forming, transfer to a work surface.
    Knead energetically, stretching dough and folding it back, turning 90° each time. Once smoother, add olive oil in 3–4 batches, letting it absorb fully. Finally, add salt and knead until incorporated. Cover dough with a bowl and rest 15 minutes.
    Perform slap & fold folds: lift dough, slap it on the counter, and fold over itself 2–3 times. Rest covered for 15 minutes. Repeat at least twice, resting 15 minutes between each round.
    Place dough in an oiled bowl, cover with plastic wrap, and let rise at room temperature (26–28 °C) for about 3 hours until tripled in volume.
    Oil a 25×38 cm baking tray. Transfer dough and gently stretch toward edges with your fingers. If it resists, rest covered 5 minutes, then continue. Let rise covered for another 1 hour.
    Pour 60 g olive oil on top, dimple surface with fingertips, and sprinkle with Maldon salt.
    Bake in preheated static oven at 200 °C for about 30 minutes on the lowest rack until golden. Serve hot.
  `
},

{ 
  title: "Pane (Bread)", 
  categories: ["Bread"], 
  ingredients: [
    "800 g flour",
    "450 g water",
    "Brewer's yeast (as needed)",
    "2 tablespoons olive oil",
    "1 heaping tablespoon salt",
    "1 teaspoon honey"
  ],
  instructions: `
    In a large bowl, pour the flour and create a well in the center.
    Dissolve the brewer's yeast in a small amount of lukewarm water and pour it into the well.
    Add the remaining water, olive oil, salt, and honey. Begin mixing until the dough is smooth and homogeneous.
    Let the dough rest for 20 minutes, covered with a cloth.
    (For quick bread) After 20 minutes, divide the dough into loaves of the desired size. Cover the loaves and let them rise in a warm place for 2–4 hours until they double in size. Proceed to bake.
    (For slow fermentation bread) Prepare the dough as above, then refrigerate it for 12–18 hours to allow it to mature. After maturation, shape the dough into loaves and let them rise for 3–4 hours at room temperature. Proceed to bake.
    Before baking, make shallow cuts across the top of each loaf to ensure even cooking.
    Bake in a preheated static oven at 250 °C (480 °F) until fully cooked and golden brown.
  `
},

{ 
  title: "Piadina", 
  categories: ["Bread","Flatbread"], 
  ingredients: [
    "500 g flour",
    "250 ml water (or 150 ml water + 100 ml milk)",
    "50 g margarine or butter",
    "1 tablespoon olive oil",
    "1 tablespoon salt",
    "10 g baking powder"
  ],
  instructions: `
    In a large bowl, sift together the flour and baking powder. Add the salt and mix well.
    Melt the margarine (or butter) and add it to the flour mixture along with the olive oil.
    If using both water and milk, mix them together, then gradually add the liquid to the flour mixture, kneading until a smooth and homogeneous dough forms.
    Cover the dough with a cloth and let it rest at room temperature for 30 minutes.
    After resting, divide the dough into 6 equal portions and shape them into balls. Cover the balls and let them rest for another 30 minutes.
    Roll out each ball on a lightly floured surface with a rolling pin into a thin disk, about 2–3 mm thick.
    Heat a non-stick skillet over medium-high heat. Cook each piadina in the hot skillet for about 2–3 minutes on each side, or until golden spots appear on the surface. Flip the piadina once during cooking.
  `
},

{ 
  title: "Mozzarella Fritta", 
  categories: ["Appetizer","Fried"], 
  ingredients: [
    "500 g mozzarella",
    "3 medium eggs",
    "20 g whole milk",
    "All-purpose flour (q.b.)",
    "Breadcrumbs (q.b.)",
    "Fine salt (q.b.)",
    "Black pepper (q.b.)",
    "1 L peanut oil (for frying)"
  ],
  instructions: `
    Cut mozzarella into slices about 2 cm thick, then into cubes. Place in a colander and let drain well to remove excess liquid.
    In a bowl, beat the eggs with salt and pepper, then add the milk.
    Pat the mozzarella cubes dry. Coat first in flour, then dip in the egg mixture, and finally roll in breadcrumbs. For extra crispiness, repeat the coating in egg and breadcrumbs (double breading).
    Heat peanut oil in a deep pan to 170–180 °C. Fry a few cubes at a time for about 2 minutes until golden and crunchy.
    Drain on paper towels to remove excess oil. Serve immediately while the mozzarella is still melted and stretchy inside.
  `
},

    ];

    // Merge-in user recipes saved locally (private additions)
    let recipes = [];
    function loadUserRecipes(){
      try{ const raw = localStorage.getItem('userRecipes'); return raw ? JSON.parse(raw) : []; }catch(_){ return []; }
    }
    function saveUserRecipes(arr){ try{ localStorage.setItem('userRecipes', JSON.stringify(arr)); }catch(_){} }
    function recomputeRecipes(){ recipes = [...baseRecipes, ...loadUserRecipes()]; }

    // --- State & helpers ---
    let selectedCategory = localStorage.getItem('cat') || 'All';
    let selectedRecipeId = null; // when set, show only that recipe

    const slug = s => s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
    const escapeHtml = s => s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));

    function highlight(text, term){
      if(!term) return escapeHtml(text);
      const safe = term.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
      return escapeHtml(text).replace(new RegExp(`(${safe})`,`ig`), '<mark>$1</mark>');
    }

    function debounced(fn, wait=120){
      let t;return (...args)=>{clearTimeout(t);t=setTimeout(()=>fn(...args),wait)}
    }

    function collectCategories(list){
      const set = new Set(['All']);
      list.forEach(r=>{ (r.categories||['Uncategorized']).forEach(c=> set.add(c)); });
      return Array.from(set);
    }

    function renderCategories(list){
      const nav = document.getElementById('categories');
      nav.innerHTML = '';
      const cats = collectCategories(list);
      cats.forEach((c,idx)=>{
        const b = document.createElement('button');
        b.className = 'pill';
        b.type = 'button';
        b.textContent = c;
        b.setAttribute('aria-pressed', String(c===selectedCategory));
        b.setAttribute('data-index', idx);
        b.addEventListener('click', ()=>{ selectedCategory = c; localStorage.setItem('cat', c); selectedRecipeId=null; update(); });
        nav.appendChild(b);
      });
    }

    function renderIndex(list){
      const ul = document.getElementById('recipe-index');
      ul.innerHTML = '';
      list.forEach(r=>{
        const id = slug(r.title);
        const li = document.createElement('li');
        li.innerHTML = `<a href="#${id}" data-id="${id}">${escapeHtml(r.title)}</a>`;
        ul.appendChild(li);
      });
      document.getElementById('count').textContent = `${list.length} recipe${list.length===1?'':'s'}`;
      ul.querySelectorAll('a').forEach(a=>{
        a.addEventListener('click', (e)=>{
          selectedRecipeId = a.getAttribute('data-id');
          update();
        });
      });
    }

    
    function renderRecipes(list, term=''){
      const wrap = document.getElementById('recipe-list');
      wrap.innerHTML = '';
      let items = list;
      if(selectedRecipeId){ items = list.filter(r=> slug(r.title)===selectedRecipeId); }
      items.forEach(r=>{
        const id = slug(r.title);
        const art = document.createElement('article');
        art.className = 'recipe';
        art.id = id;
        art.tabIndex = -1;
        const ing = r.ingredients.map(i=>`<li>${highlight(i, term)}</li>`).join('');
        const cats = (r.categories||['Uncategorized']).join(', ');
        art.innerHTML = `
          <h3><button class="btn" data-open="${id}" style="border:none;background:transparent;padding:0;font:inherit;color:inherit;text-align:left">${highlight(r.title, term)}</button></h3>
          <div class="meta">${r.ingredients.length} ingredients • ${cats}</div>
          <div class="actions">
            <button class="btn" data-copy="${id}-ingredients" aria-label="Copy ingredients for ${escapeHtml(r.title)}">Copy ingredients</button>
            <button class="btn" data-copy="${id}-instructions" aria-label="Copy instructions for ${escapeHtml(r.title)}">Copy steps</button>
                      </div>
          <h4>Ingredients</h4>
          <ul id="${id}-ingredients">${ing}</ul>
          <h4>Instructions</h4>
          <div id="${id}-instructions"><p>${highlight(r.instructions.trim(), term).replace(/\n\n/g,'</p><p>')}</p></div>
        `;
        wrap.appendChild(art);
      });
      // Title click also enables single view
      wrap.querySelectorAll('[data-open]').forEach(b=>{
        b.addEventListener('click', ()=>{
          selectedRecipeId = b.getAttribute('data-open');
          update();
          const target = document.getElementById(selectedRecipeId);
          if(target) target.focus({preventScroll:true});
        });
      });
      // Copy buttons
      wrap.querySelectorAll('[data-copy]').forEach(b=>{
        b.addEventListener('click', async ()=>{
          const sel = document.getElementById(b.getAttribute('data-copy'));
          const txt = sel ? sel.innerText.replace(/\n+/g,'\n').trim() : '';
          try{ await navigator.clipboard.writeText(txt); b.textContent = 'Copied!'; setTimeout(()=>{ const isIng = b.getAttribute('data-copy').includes('ingredients'); b.textContent = 'Copy ' + (isIng?'ingredients':'steps'); },1200);}catch(e){ alert('Could not copy.'); }
        });
      });

      // Single bar state
      const bar = document.getElementById('single-bar');
      const label = document.getElementById('single-label');
      if(selectedRecipeId){
        const r = list.find(x=> slug(x.title)===selectedRecipeId) || {title:selectedRecipeId};
        bar.classList.add('show');
        label.textContent = `Viewing: ${r.title}`;
      } else {
        bar.classList.remove('show');
        label.textContent = '';
      }
    }

    function filter(list, q){
      const matchSearch = (r)=>{
        if(!q) return true;
        const t = q.toLowerCase();
        return r.title.toLowerCase().includes(t) ||
          (r.categories||[]).some(cat=>cat.toLowerCase().includes(t)) ||
          r.ingredients.some(i=>i.toLowerCase().includes(t)) ||
          r.instructions.toLowerCase().includes(t);
      };
      const matchCat = (r)=> selectedCategory==='All' ? true : (r.categories||['Uncategorized']).includes(selectedCategory);
      return list.filter(r=> matchSearch(r) && matchCat(r));
    }

    const onSearch = debounced(()=>{ selectedRecipeId=null; localStorage.setItem('q', document.getElementById('search-bar').value.trim()); update(); }, 150);

    function handleHash(){
      const id = location.hash.replace('#','');
      selectedRecipeId = id || null;
      update(true); // keep current hash
      if(id){
        const target = document.getElementById(id);
        if(target){ target.scrollIntoView({behavior:'smooth', block:'start'}); target.focus({preventScroll:true}); }
      }
    }

    function update(keepHash){
      const q = document.getElementById('search-bar').value.trim();
      const filtered = filter(recipes, q);
      renderCategories(recipes);
      [...document.querySelectorAll('#categories .pill')].forEach(b=> b.setAttribute('aria-pressed', String(b.textContent===selectedCategory)));
      renderIndex(filtered);
      renderRecipes(filtered, q);
      if(!keepHash){
        if(selectedRecipeId) location.hash = '#' + selectedRecipeId; else history.replaceState(null,'', location.pathname + location.search);
      }
    }

    // --- Minimal tests (original + more) ---
    function runTests(){
      const out = [];
      const ok = (cond, name)=>{ out.push({name, cond}); };
      try{
        const target = 'a+b (c)? [x] \\ ^ $';
        const term = 'a+b (c)? [x] \\ ^ $';
        const res = highlight(target, term);
        ok(res.includes('<mark>'), 'highlight() marks a term with regex specials');
      }catch(e){ ok(false, 'highlight() throws with regex specials'); }

      // Existing tests
      const prev = selectedCategory; selectedCategory = 'Pasta';
      ok(filter(recipes, '').length === 2, 'filter() by category only (Pasta) returns 2');
      selectedCategory = prev;

      const prev2 = selectedCategory; selectedCategory = 'Meat';
      ok(filter(recipes, 'Dijon').map(r=>r.title).sort().join(',') === 'Filetto al Pepe Verde,Poulet Crémeux à la Dijon', 'filter() combines category AND search');
      selectedCategory = prev2;

      const before = document.getElementById('recipe-list').children.length;
      selectedRecipeId = 'pasta'; update();
      const after = document.getElementById('recipe-list').children.length;
      ok(before > 1 && after === 1, 'single-view shows only one article');
      selectedRecipeId = null; update();

      ok(typeof navigator.clipboard !== 'undefined', 'Clipboard API exists (may fail in some contexts)');

      // New tests
      ok(escapeHtml('<>&"\'').includes('&lt;') && escapeHtml('<>&"\'').includes('&quot;'), 'escapeHtml() escapes HTML chars');
      ok('a\nb'.split('\n').length === 2, 'JS newline split works');
      ok(document.getElementById('add-form') && document.getElementById('add-ings'), 'Add modal form exists');

      const passed = out.filter(t=>t.cond).length;
      const failed = out.length - passed;
      const el = document.getElementById('test-output');
      el.innerHTML = failed>0
        ? `<span class="fail">✗ ${failed} tests failed (${passed} passed)</span>`
        : '';
      try{ console.table(out.map(t=>({test:t.name, result:t.cond?'PASS':'FAIL'}))); }catch(_){}}

    (function init(){
      document.getElementById('year').textContent = new Date().getFullYear();

      // Private mode detection: localhost/.local OR ?admin OR stored flag
      const url = new URL(location.href);
      if(url.searchParams.has('admin')){ localStorage.setItem('cookbook_admin','1'); url.searchParams.delete('admin'); history.replaceState(null,'', url.pathname + (url.searchParams.toString()?('?'+url.searchParams.toString()):'')); }
      const isPrivate = ['localhost','127.0.0.1','::1',''].includes(location.hostname) || location.hostname.endsWith('.local') || localStorage.getItem('cookbook_admin')==='1';

      // Build recipes with user additions
      recomputeRecipes();

      renderCategories(recipes);
      renderIndex(recipes);
      renderRecipes(recipes);

      const search = document.getElementById('search-bar');
      const savedQ = localStorage.getItem('q');
      if(savedQ){ search.value = savedQ; }
      search.addEventListener('input', onSearch);

      document.getElementById('show-all').addEventListener('click', ()=>{ selectedRecipeId=null; update(); });
      window.addEventListener('hashchange', handleHash);

      // Shortcuts
      window.addEventListener('keydown', (e)=>{
        if(e.key === '/' && document.activeElement !== search){ e.preventDefault(); search.focus(); return; }
        if(e.key === 'Escape' && selectedRecipeId){ selectedRecipeId = null; update(); }
        if(['ArrowLeft','ArrowRight'].includes(e.key)){
          const pills = [...document.querySelectorAll('#categories .pill')];
          const idx = pills.findIndex(p=>p.textContent===selectedCategory);
          if(idx !== -1){
            const next = e.key==='ArrowRight' ? Math.min(idx+1, pills.length-1) : Math.max(idx-1, 0);
            pills[next].click();
          }
        }
        if(e.key === 'Enter' && !selectedRecipeId){
          const first = document.querySelector('#recipe-index a');
          if(first){ first.click(); }
        }
      });

      // Private add button wiring
      const addBtn = document.getElementById('add-recipe');
      const modal = document.getElementById('add-modal');
      const form = document.getElementById('add-form');
      const cancel = document.getElementById('add-cancel');
      if(isPrivate){ addBtn.hidden = false; }

      function openModal(){ modal.style.display = 'grid'; modal.setAttribute('aria-hidden','false'); document.getElementById('add-title-input').focus(); }
      function closeModal(){ modal.style.display = 'none'; modal.setAttribute('aria-hidden','true'); form.reset(); }
      addBtn.addEventListener('click', openModal);
      cancel.addEventListener('click', closeModal);
      modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });

      form.addEventListener('submit', (e)=>{
        e.preventDefault();
        const title = (document.getElementById('add-title-input').value||'').trim();
        const cats = (document.getElementById('add-cats').value||'').split(',').map(s=>s.trim()).filter(Boolean);
        const ings = (document.getElementById('add-ings').value||'').split('\n').map(s=>s.trim()).filter(Boolean);
        const steps = (document.getElementById('add-steps').value||'').trim();
        if(!title || !steps || ings.length===0){ alert('Please fill title, at least one ingredient, and instructions.'); return; }
        const rec = { title, categories: (cats.length?cats:['Uncategorized']), ingredients: ings, instructions: steps };
        // Save to local storage list
        const current = loadUserRecipes();
        current.push(rec); saveUserRecipes(current);
        recomputeRecipes();
        selectedRecipeId = (title.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''));
        update();
        
        closeModal();
      });

      handleHash();
      runTests();
    })();
  </script>
</body>
</html>
